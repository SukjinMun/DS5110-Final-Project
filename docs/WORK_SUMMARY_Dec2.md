# Work Summary - December 2, 2025

**Author:** Suk Jin Mun
**Course:** DS 5110, Fall 2025

---

## Quick Reference - Key Files

| What | File |
|------|------|
| Data generation with ESI correlations | `dataset/generate_ed_csvs.py` |
| Clinical validation & citations | `dataset/README.md` |
| Model training (SMOTE, RF, GB) | `scripts/train_models.py` |
| Validation methodology | `scripts/model_validation.py` |
| Updated model results | `docs/MODEL_RESULTS.md` |
| Validation figures | `figs/validation_*.png` |

## Complete List of Files Changed

### Files Modified
| File | Change |
|------|--------|
| `dataset/generate_ed_csvs.py` | Added ESI correlations (vitals, chief complaint, arrival mode) |
| `dataset/README.md` | **NEW** - Clinical validation documentation with citations |
| `scripts/train_models.py` | Added SMOTE, StandardScaler, Random Forest, Gradient Boosting |
| `scripts/model_validation.py` | **NEW** - Validation script (CV, ROC, learning curves) |
| `scripts/test_models.py` | Updated for new model format `{'model', 'scaler'}` |
| `backend/routes/predictions.py` | Added RF/GB endpoints, updated accuracy numbers |
| `docs/MODEL_RESULTS.md` | Rewrote with new accuracy (94%) and validation results |
| `docs/WORK_SUMMARY_Dec2.md` | **NEW** - This file (work summary for teammates) |
| `README.md` | Updated accuracy table, added RF/GB to file list |
| `backend/README.md` | Updated model list, marked tasks complete |
| `project_progress_tracker.xlsx` | Marked Suk Jin's tasks as Complete (green rows) |

### Files Regenerated (by running scripts)
| File | How |
|------|-----|
| `dataset/*.csv` (all 7 files) | Regenerated by running `python generate_ed_csvs.py` |
| `trained_models/esi_random_forest.pkl` | **NEW** - trained by `train_models.py` |
| `trained_models/esi_gradient_boosting.pkl` | **NEW** - trained by `train_models.py` |
| `trained_models/esi_logistic.pkl` | Retrained with SMOTE |
| `trained_models/esi_lda.pkl` | Retrained with SMOTE |
| `trained_models/esi_naive_bayes.pkl` | Retrained with SMOTE |
| `trained_models/wait_time_predictor.pkl` | Retrained |
| `trained_models/volume_predictor.pkl` | Retrained |
| `figs/validation_confusion_matrices.png` | **NEW** - created by `model_validation.py` |
| `figs/validation_roc_curves.png` | **NEW** - created by `model_validation.py` |
| `figs/validation_learning_curves.png` | **NEW** - created by `model_validation.py` |

**Total: 11 files modified/created + 7 CSVs + 7 models + 3 figures regenerated**

---

## TL;DR for Teammates

### 1. Why Was Accuracy Low (~54%)?

The original dataset assigned ESI levels **completely randomly**. A patient with normal vitals could get ESI 1 (critical), and a patient with severe symptoms could get ESI 5 (non-urgent).

**No model can predict a target that has no relationship to features.** This was a dataset problem, not a model problem.

### 2. How Did We Fix the Dataset?

We made ESI correlate with features **the same way real triage works**:

- **Vital signs**: Sicker patients (ESI 1-2) now have abnormal vitals (high heart rate, low SpO2, high respiratory rate)
- **Chief complaint**: "Chest pain" and "Shortness of breath" → more likely ESI 1-2; "Cough" → more likely ESI 4-5
- **Arrival mode**: Critical patients (ESI 1) arrive by EMS 85% of the time; non-urgent patients walk in

### 3. How Do We Know It's Realistic (Not Cheating)?

All correlations are based on **published ESI clinical guidelines**:

- **ESI Handbook Version 5** defines "Danger Zone" vitals: HR >100, SpO2 <90%, RR >20
- Our ESI 1-2 patients have vitals in these danger zones
- Our ESI 3-5 patients have normal vitals
- This is how **real nurses triage patients** - we just made our synthetic data follow the same rules

Full citations in `dataset/README.md`.

### 4. How Did We Validate the Models?

Applied DS5110 class methodologies:

| Method | Result | Meaning |
|--------|--------|---------|
| 5-fold cross-validation | 93.89% ± 0.52% | Consistent across folds |
| Train-test gap | 5.19% | No overfitting (gap <10% is acceptable) |
| ROC/AUC | 0.9946 | Excellent discrimination |
| ESI 1 Recall | 94.44% | Won't miss critical patients |
| ESI 2 Recall | 92.69% | Won't miss emergent patients |

### 5. Does This Affect Your Work?

**No.** Only data VALUES changed, not structure:
- Same CSV columns
- Same database schema
- Same API endpoints

Shaobo's database scripts and Xiaobai's frontend work unchanged.

---

## Detailed Technical Documentation

### Problem Statement

Initial classification models had poor accuracy (~54%) because the synthetic dataset had **no correlation between ESI levels and patient features** (vital signs, chief complaint, arrival mode). ESI was assigned randomly.

---

## Solution Implemented

### 1. Data Generation Improvements

**File Modified:** `dataset/generate_ed_csvs.py`

Added clinically-validated correlations based on ESI Handbook Version 5:

#### ESI-Based Vital Sign Distributions
```python
ESI_VITALS = {
    1: {"heart_rate": (130, 15), "systolic_bp": (75, 12), "spo2": (82, 5), ...},
    2: {"heart_rate": (110, 12), "systolic_bp": (95, 10), "spo2": (89, 4), ...},
    3: {"heart_rate": (88, 10), "systolic_bp": (122, 10), "spo2": (96, 2), ...},
    4: {"heart_rate": (75, 8), "systolic_bp": (128, 8), "spo2": (98, 1), ...},
    5: {"heart_rate": (68, 6), "systolic_bp": (120, 6), "spo2": (99, 0.5), ...},
}
```

#### Chief Complaint to ESI Mapping
- Chest pain → 35% ESI 1-2
- Shortness of breath → 43% ESI 1-2
- Cough → 6% ESI 1-2

#### Arrival Mode by ESI
- ESI 1: 85% EMS, 10% Walk-in
- ESI 5: 5% EMS, 92% Walk-in

**Clinical Validation:** See `dataset/README.md` for full documentation with ESI Handbook citations.

### 2. Model Training Improvements

**File Modified:** `scripts/train_models.py`

Added:
- **SMOTE** (Synthetic Minority Over-sampling Technique) for class imbalance
- **StandardScaler** for feature scaling
- **Random Forest** classifier (500 trees, max_depth=30)
- **Gradient Boosting** classifier (300 estimators, max_depth=8)
- Model saved as dict: `{'model': clf, 'scaler': scaler}`

### 3. Model Validation Script

**File Created:** `scripts/model_validation.py`

Implements DS5110 class methodologies:
- K-fold cross-validation (K=5)
- Confusion matrix analysis
- ROC curves and AUC (One-vs-Rest for multiclass)
- Learning curves (bias-variance tradeoff)
- Per-class precision/recall/F1

### 4. API Updates

**File Modified:** `backend/routes/predictions.py`

- Added Random Forest and Gradient Boosting endpoints
- Updated model loading for new dict format
- Updated accuracy numbers in models_info()

---

## Results

### Classification Model Performance

| Model | Before | After | Improvement |
|-------|--------|-------|-------------|
| Random Forest | N/A | **94.06%** | NEW (BEST) |
| Gradient Boosting | N/A | 93.28% | NEW |
| Logistic Regression | 54.84% | 93.44% | +38.60% |
| LDA | 54.84% | 90.16% | +35.32% |
| Naive Bayes | 46.98% | 90.16% | +43.18% |

### Validation Metrics

| Metric | Value | Interpretation |
|--------|-------|----------------|
| 5-Fold CV Accuracy | 93.89% ±0.52% | Consistent performance |
| Train-Test Gap | 5.19% | No overfitting |
| Macro AUC | 0.9946 | Excellent discrimination |
| ESI 1 Recall | 94.44% | Clinically safe |
| ESI 2 Recall | 92.69% | Clinically safe |

---

## Files Modified

| File | Change Type | Description |
|------|-------------|-------------|
| `dataset/generate_ed_csvs.py` | Modified | Added ESI correlations |
| `dataset/README.md` | Created | Clinical validation documentation |
| `dataset/*.csv` | Regenerated | New data with correlations |
| `scripts/train_models.py` | Modified | Added SMOTE, RF, GB, scaling |
| `scripts/model_validation.py` | Created | Validation methodology |
| `scripts/test_models.py` | Modified | Updated for new model format |
| `backend/routes/predictions.py` | Modified | API updates |
| `trained_models/*.pkl` | Regenerated | Retrained models |
| `figs/validation_*.png` | Created | Validation figures |
| `docs/MODEL_RESULTS.md` | Modified | Updated accuracy numbers |
| `README.md` | Modified | Updated model table |
| `backend/README.md` | Modified | Updated status |

---

## Compatibility Check

### Files NOT Affected (Confirmed)

| File | Owner | Status |
|------|-------|--------|
| `database/db_setup.sql` | Shaobo | ✅ Compatible (same schema) |
| `database/db_import.sql` | Shaobo | ✅ Compatible (same CSV structure) |
| `backend/models/orm_models.py` | Suk Jin | ✅ Compatible (same columns) |
| `backend/app.py` | Suk Jin | ✅ Compatible |
| `backend/routes/api.py` | Suk Jin | ✅ Compatible |
| `frontend/*` | Xiaobai | ✅ Compatible (API unchanged) |

### Why No Breaking Changes

1. **CSV Structure Unchanged**: Same columns, same data types
2. **Database Schema Unchanged**: Same tables, same relationships
3. **API Endpoints Unchanged**: Same request/response format
4. Only DATA VALUES changed (correlations), not STRUCTURE

---

## Validation Documentation

All improvements are based on published clinical guidelines:

1. **ESI Handbook Version 5** (Emergency Nurses Association)
   - URL: https://media.emscimprovement.center/documents/Emergency_Severity_Index_Handbook.pdf

2. **AHRQ ESI Guidelines**
   - URL: https://www.ahrq.gov/patient-safety/settings/emergency-dept/esi.html

3. **StatPearls - Emergency Department Triage**
   - URL: https://www.ncbi.nlm.nih.gov/books/NBK557583/

See `dataset/README.md` for complete clinical validation documentation.

---

## Next Steps

- [ ] Finalize GitHub repository for submission
- [ ] Submit final deliverables
- [ ] Team review of changes

---

**Document Version:** 1.0
**Created:** December 2, 2025
